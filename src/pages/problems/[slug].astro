---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import TerminalPrompt from '../../components/TerminalPrompt.astro';
import TimelineEntry from '../../components/TimelineEntry.astro';
import '../../components/MDXComponents.astro';

// Generate static paths for all problems
export async function getStaticPaths() {
  const problems = await getCollection('problems');
  return problems.map((problem) => ({
    params: { slug: problem.slug },
    props: { problem },
  }));
}

const { problem } = Astro.props;
const { Content } = await problem.render();
const { title, description, tags, started } = problem.data;

// Auto-link: find timeline entries that share any tag with this problem
const allTimelineEntries = await getCollection('timeline');
const relatedWork = allTimelineEntries
  .filter((entry) => entry.data.tags.some((tag) => tags.includes(tag)))
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());
---

<BaseLayout title={title} description={description}>
  <div class="mb-6">
    <a
      href="/problems"
      class="inline-flex items-center gap-1 font-mono text-terminal-sm text-terminal-blue hover:underline"
    >
      <svg
        class="h-4 w-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"
        ></path>
      </svg>
      Back to problems
    </a>
  </div>

  <TerminalPrompt command={`cat problems/${problem.slug}.mdx`}>
    {/* Problem header */}
    <div class="mb-8 border-b border-terminal-border pb-6">
      {/* Start date */}
      <div class="mb-3">
        <span class="font-mono text-terminal-sm text-terminal-text-muted">
          Thinking about since {started}
        </span>
      </div>

      {/* Title (the question) */}
      <h1 class="mb-3 font-mono text-3xl font-bold text-terminal-text md:text-4xl">
        {title}
      </h1>

      {/* Description */}
      <p class="mb-4 text-lg leading-relaxed text-terminal-text-secondary">
        {description}
      </p>

      {/* Tags */}
      <div class="flex flex-wrap gap-2">
        {tags.map((tag) => <span class="terminal-badge text-terminal-text-muted">{tag}</span>)}
      </div>
    </div>

    {/* MDX content */}
    <div class="mdx-content">
      <Content />
    </div>
  </TerminalPrompt>

  {/* Related Work Section - auto-linked from timeline */}
  {
    relatedWork.length > 0 && (
      <div class="mt-8">
        <TerminalPrompt command={`grep -l "${tags[0]}" timeline/*.mdx`}>
          <h2 class="mb-4 font-mono text-2xl font-bold text-terminal-text">Related Work</h2>
          <p class="mb-6 text-terminal-text-secondary">
            Timeline entries that share tags with this problem.
          </p>
          <div class="space-y-6">
            {relatedWork.map((entry) => (
              <TimelineEntry entry={entry} />
            ))}
          </div>
        </TerminalPrompt>
      </div>
    )
  }

  {/* Footer navigation */}
  <div class="mt-8 border-t border-terminal-border pt-6">
    <a
      href="/problems"
      class="inline-flex items-center gap-1 font-mono text-terminal-sm text-terminal-blue hover:underline"
    >
      <svg
        class="h-4 w-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"
        ></path>
      </svg>
      Back to problems
    </a>
  </div>
</BaseLayout>
